ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ Lifecycle ç”Ÿå‘½å‘¨æœŸç»„ä»¶çš„é‚£äº›äº‹
https://juejin.cn/post/7168868230977552421

1.LifecycleRegistry
Lifecycle çš„å…·ä½“å®ç°è€…,æ­£å¦‚å…¶åæ‰€ç¤ºï¼Œä¸»è¦ç”¨äºç®¡ç†å½“å‰è®¢é˜…çš„ è§‚å¯Ÿè€…å¯¹è±¡ ,æ‰€ä»¥ä¹Ÿæ‰¿æ‹…äº† Lifecycle å…·ä½“çš„å®ç°é€»è¾‘

    addObserver
    public void addObserver(@NonNull LifecycleObserver observer){
        // åˆå§‹åŒ–çŠ¶æ€,destory or init
        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;
        // ğŸ“Œ åˆå§‹åŒ–å®é™…åˆ†å‘çŠ¶æ€çš„åŒ…è£…ç±»
        ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);
        // å°†è§‚å¯Ÿè€…æ·»åŠ åˆ°å…·ä½“çš„mapä¸­,å¦‚æœå·²ç»å­˜åœ¨äº†åˆ™è¿”å›ä¹‹å‰çš„,å¦åˆ™åˆ›å»ºæ–°çš„æ·»åŠ åˆ°mapä¸­
        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);
        // å¦‚æœä¸Šä¸€æ­¥æ·»åŠ æˆåŠŸäº†,putIfAbsentä¼šè¿”å›null
        if (previous != null) {
            return;
        }
        
         // å¦‚æœactæˆ–è€…ffè¢«å›æ”¶äº†,ç›´æ¥return
         LifecycleOwner lifecycleOwner = mLifecycleOwner.get();
         if (lifecycleOwner == null) {
            return;
         }

         // å½“å‰æ·»åŠ çš„è§‚å¯Ÿè€…æ•°é‡!=0||æ­£åœ¨å¤„ç†äº‹ä»¶
         boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent;
        // ğŸ“Œ å–å¾—è§‚å¯Ÿè€…å½“å‰çš„çŠ¶æ€...mObserverMapä¸­ObserverWithState
        State targetState = calculateTargetState(observer);
        mAddingObserverCounter++;
        // ğŸ“Œ å¦‚æœå½“å‰è§‚å¯Ÿè€…çŠ¶æ€å°äºå½“å‰ç”Ÿå‘½å‘¨æœŸæ‰€åœ¨çŠ¶æ€&&è¿™ä¸ªè§‚å¯Ÿè€…å·²ç»è¢«å­˜åˆ°äº†è§‚å¯Ÿè€…åˆ—è¡¨ä¸­
        while ((statefulObserver.mState.compareTo(targetState) < 0
                && mObserverMap.contains(observer))) {
                // ä¿å­˜å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
                pushParentState(statefulObserver.mState);
                // è¿”å›å½“å‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å¯¹åº”çš„æ¥ä¸‹æ¥çš„äº‹ä»¶åºåˆ—
                final Event event = Event.upFrom(statefulObserver.mState);
                ...
                // åˆ†å‘äº‹ä»¶
                statefulObserver.dispatchEvent(lifecycleOwner, event);
                // ç§»é™¤å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
                popParentState();
                // å†æ¬¡è·å¾—å½“å‰çš„çŠ¶æ€,ä»¥ä¾¿ç»§ç»­æ‰§è¡Œ
                targetState = calculateTargetState(observer);
        }
        
        // å¤„ç†ä¸€éäº‹ä»¶,ä¿è¯äº‹ä»¶åŒæ­¥
        if (!isReentrance) {
            sync();
        }
        // å›å½’é»˜è®¤å€¼
        mAddingObserverCounter--;
    }

2.Activityä¸­çš„å®ç°
    ComponentActivity
    Activity ä¸­è°ƒç”¨ getLifecycle()æ—¶,å†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨äº† ComponentActivity.mLifecycleRegistry,å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š
    ReportFragment.injectIfNeededIn(this);
    å†…éƒ¨ä¼šå¯¹sdkè¿›è¡Œåˆ¤æ–­ï¼Œå¯¹åº”ç€ä¸¤å¥—æµç¨‹ï¼Œå¯¹äº sdk>=29 çš„,é€šè¿‡æ³¨å†Œ Activity.registerActivityLifecycleCallbacks() äº‹ä»¶å®ç°ç›‘å¬ï¼Œå¯¹äº sdk<29 çš„,é‡å†™ Fragment ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å®Œæˆã€‚

3.Fragmentä¸­çš„å®ç°
    lifecycle å®ä¾‹ä¼šåœ¨ Fragment æ„é€ å‡½æ•° ä¸­è¿›è¡Œåˆå§‹åŒ–,è€Œ mViewLifecycleOwner ä¼šåœ¨ performCreateView() æ‰§è¡Œæ—¶åˆå§‹åŒ–,ç„¶ååœ¨ç›¸åº”çš„ performXxx ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæ—¶,è°ƒç”¨ç›¸åº”çš„ lifecycle.handleLifecycleEvent() ä»è€Œå®Œæˆäº‹ä»¶çš„é€šçŸ¥ã€‚
